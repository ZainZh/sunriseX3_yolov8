# bpu_yolov8
## ä»»åŠ¡æè¿°

ä¸ºäº†å®ç°è½»é‡åŒ–æ¨¡å‹éƒ¨ç½²ï¼Œä»¥æ»¡è¶³å¯¹ä¸€äº›å°å‹è®¾å¤‡å¯¹ç‰©ä½“è¯†åˆ«çš„è¦æ±‚ã€‚åœ¨yoloç³»åˆ—å¼€å‘è€…[tripleMu](https://github.com/triple-Mu)çš„å¸®åŠ©ä¸‹ï¼Œå®ç°äº†å°†æœ€æ–°æ¡†æ¶yolov8çš„æœ€æ–°ç‰ˆæœ¬è‡ªå®šä¹‰è®­ç»ƒæ¨¡å‹éƒ¨ç½²åˆ°æ—­æ—¥x3æ´¾ä¸Šè¿›è¡Œè¿è¡Œã€‚è¿è¡Œå¸§æ•°ç›®å‰ä¸º4-5å¸§å·¦å³ã€‚

åŒæ—¶åŸºäºä»¥ä¸Šé™æ€ç›‘æµ‹æ‰©å±•å®ç°äº†yolov8æ¨¡å‹ä¸‹çš„mipiæ‘„åƒå¤´å®æ—¶æ£€æµ‹ï¼Œä¸ºåç»­è¿æ¥æœ«ç«¯æ‰§è¡Œå™¨å¹¶å®ç°æ§åˆ¶æ‰“ä¸‹åŸºç¡€ã€‚


[](https://github.com/ZainZh/bpu_yolov8)

## å‰åºå¼€å‘æ¿ä¸å¼€å‘æœºé…ç½®

å…³äºå¼€å‘æ¿ä¸Šè¿è¡Œç¯å¢ƒçš„è®¾ç½®ä¸å¼€å‘æœºå¼€å‘ç¯å¢ƒçš„è®¾ç½®å‚è€ƒè¯¥æ–‡æ¡£è¿›è¡Œé…ç½®ã€‚

[å¤©å·¥å¼€ç‰©X3è®¡ç®—ç‰ˆ](https://www.notion.so/X3-96a26f3828b649ad8876a272b3ade756)

## æ›´æ”¹æ€è·¯

æ ¹æ®ç½‘ç»œä¸Šçš„æ•™ç¨‹å’Œè®¨è®ºï¼Œå‘ç°åœ¨pytorchè®­ç»ƒå¾—åˆ°ptæ¨¡å‹åè½¬ä¸ºonnxæ¨¡å‹çš„è¿‡ç¨‹ä¸­ï¼ŒDetectç±»ä¸­çš„forwardå‡½æ•°ä¸­ï¼Œä¼šå¯¹å¾—åˆ°çš„é¢„æµ‹ç»“æœè¿›è¡Œè¿›è¡Œåå¤„ç†å°è£…ï¼ˆå°è£…æˆä¸€ä¸ªæ•´ä½“çš„resultæ•°æ®ç»“æ„ï¼‰ï¼ŒåŒæ—¶ç”±äºX3æ´¾ä¸­æ”¯æŒçš„æ¨¡å‹ç»“æ„ä¸º`NHWC`ç»“æ„ï¼Œè€Œpytorchè®­ç»ƒå¾—åˆ°çš„æ¨¡å‹ä¸º`NCHW`ç»“æ„ï¼Œæ‰€ä»¥æå‰å¯¹forwardå‡½æ•°ä¸­å¾—åˆ°çš„æ¨¡å‹ç»“æ„è¿›è¡ŒTransposeè½¬æ¢ï¼Œé¿å…åœ¨æ¿ä¸­è¿è¡Œæ—¶è¿›è¡Œä¸å¿…è¦çš„è®¡ç®—ï¼Œæ‹–æ…¢è®¡ç®—é€Ÿåº¦ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨é€šè¿‡æœ€æ–°yoloV8ï¼Œpytorchè®­ç»ƒæ¡†æ¶å¾—åˆ°.ptè®­ç»ƒæ¨¡å‹åï¼Œéœ€è¦åœ¨è½¬æ¢onnxæ¨¡å‹å’Œæ¿è½½è¿è¡Œbinæ¨¡å‹ä¹‹å‰ï¼Œå¯¹æºä»£ç ä¸­çš„modules.pyæ–‡ä»¶ Detectç±»ä¸‹çš„ forwardå‡½æ•°è¿›è¡Œå¦‚ä¸‹ä¸¤ä¸ªå¤„ç†ï¼Œæ¥æå‡æ¿è½½è¿è¡Œæ•ˆç‡åŠå…¼å®¹æ€§ï¼š

- å»æ‰forwardå‡½æ•°ä¸­åœ¨å¾—åˆ°é¢„æµ‹resultåå¯¹äºresultçš„åå¤„ç†ã€‚
- åœ¨forwardå‡½æ•°ä¸­å¾—åˆ°é¢„æµ‹resultå, å¯¹äºç»“æœè¿›è¡ŒTransposeå¤„ç†ï¼ŒæŠŠ`NCHW`ç»“æ„çš„æ¨¡å‹æå‰è½¬æ¢ä¸º`NHWC`ç»“æ„ã€‚

## æ“ä½œæ­¥éª¤

### è®­ç»ƒæ¨¡å‹

1. åˆ›å»ºè™šæ‹Ÿpythonç¯å¢ƒyoloV8ï¼Œå¹¶è¿›å…¥ã€‚

```bash
python3.8 -m venv $HOME/.yolov8 --clear
source $HOME/.yolov8/bin/activate
```

1. æ ¹æ®yoloV8æœ€æ–°æ–‡æ¡£ï¼Œä»£ç ï¼Œå‡†å¤‡æ•°æ®é›†æ­£å¸¸è¿›è¡Œæ¨¡å‹è®­ç»ƒã€‚

â—ATTENTION:å°†yoloV8çš„ç¯å¢ƒå®‰è£…åœ¨æˆ‘ä»¬ç¬¬ä¸€æ­¥åˆ›å»ºçš„.yoloV8ç¯å¢ƒä¸­ï¼Œä¾¿äºæˆ‘ä»¬åç»­æ›´æ”¹æºç åå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚

[GitHub - ultralytics/ultralytics: NEW - YOLOv8 ğŸš€ in PyTorch > ONNX > CoreML > TFLite](https://github.com/ultralytics/ultralytics)

æœ¬æ­¥ç›®æ ‡ï¼šå¾—åˆ°yoloV8è®­ç»ƒæ¡†æ¶è®­ç»ƒå¾—åˆ°çš„åç¼€ä¸º.ptçš„æ¨¡å‹ã€‚

### å¯¼å‡ºonnxæ¨¡å‹ï¼Œbinæ¨¡å‹

åœ¨å¾—åˆ°æ­£å¸¸è®­ç»ƒæ¡†æ¶è®­ç»ƒå¾—åˆ°çš„.ptåç¼€æ¨¡å‹åï¼Œæœ¬æ­¥éª¤æœ€ç»ˆè¦å°†å…¶è½¬æ¢ä¸ºX3è®¡ç®—æ¿å¯ä»¥è¿è¡Œçš„.binåç¼€æ¨¡å‹ï¼Œä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼Œæˆ‘ä»¬è¦å…ˆå°†å…¶è½¬æ¢ä¸ºä¸­é—´æ­¥éª¤çš„.onnxæ¨¡å‹ã€‚

è€Œåœ¨å¯¼å‡ºonnxæ¨¡å‹ä¹‹å‰ï¼Œè¦æ ¹æ®å‰è¿°æ€è·¯æ¥å¯¹æºç è¿›è¡Œæ›´æ”¹ã€‚å…·ä½“æ“ä½œå¦‚ä¸‹

1. å¸è½½åŸè™šæ‹Ÿç¯å¢ƒä¸­çš„yoloV8åº“â€”â€”ultralytics

```bash
source $HOME/.yolov8/bin/activate
pip uninstall ultralytics
```

1. è¿›å…¥æœ€æ–°æ‹‰å–çš„yoloV8æºç ä½ç½®ï¼Œå¯¹modules.pyæºç è¿›è¡Œæ›´æ”¹

```bash
cd {ultralytics's location}/ultralytics/nn
```

1. æ›´æ”¹modules.pyä¸­Detectç±»ä¸­forwardå‡½æ•°ï¼Œå¹¶é‡æ–°å®‰è£…yoloV8ç¯å¢ƒã€‚

```bash
## åŸæ¥çš„ä»£ç 
def forward(self, x):
        shape = x[0].shape  # BCHW
        for i in range(self.nl):
            x[i] = torch.cat((self.cv2[i](x[i]), self.cv3[i](x[i])), 1)
        if self.training:
            return x
        elif self.dynamic or self.shape != shape:
            self.anchors, self.strides = (x.transpose(0, 1) for x in make_anchors(x, self.stride, 0.5))
            self.shape = shape

        if self.export and self.format == 'edgetpu':  # FlexSplitV ops issue
            x_cat = torch.cat([xi.view(shape[0], self.no, -1) for xi in x], 2)
            box = x_cat[:, :self.reg_max * 4]
            cls = x_cat[:, self.reg_max * 4:]
        else:
            box, cls = torch.cat([xi.view(shape[0], self.no, -1) for xi in x], 2).split((self.reg_max * 4, self.nc), 1)
        dbox = dist2bbox(self.dfl(box), self.anchors.unsqueeze(0), xywh=True, dim=1) * self.strides
        y = torch.cat((dbox, cls.sigmoid()), 1)
        return y if self.export else (y, x)
```

```bash
## å°†ä¸Šé¢çš„å‡½æ•°æ›¿æ¢ä¸ºå¦‚ä¸‹çš„ä»£ç 
def forward(self, x):
        res = []
        for i in range(self.nl):
            bboxes = self.cv2[i](x[i]).permute(0, 2, 3, 1)
            scores = self.cv3[i](x[i]).permute(0, 2, 3, 1)
            res.append(bboxes)
            res.append(scores)
        return tuple(res)
```

```bash
## å®‰è£…modifiedçš„yoloV8ç¯å¢ƒï¼Œè¿™æ­¥ä¼šå°†ä¸Šè¿°æ›´æ”¹å¥½çš„codeæ‰“åŒ…æˆapiåœ¨ç¯å¢ƒä¸­ã€‚
source $HOME/.yolov8/bin/activate
cd {ultralytics's location}
python setup.py install
```

1. è¿è¡Œä»£ç åº“ï¼ˆbpu_yolov8ï¼‰ä¸­step1_export_onnx.pyæ–‡ä»¶å¯¼å‡º.onnxåç¼€æ¨¡å‹æ–‡ä»¶
2. è¿è¡Œä»£ç åº“ï¼ˆbpu_yolov8ï¼‰ä¸­step2_make_calib.pyæ–‡ä»¶ï¼Œå¯¹å¾—åˆ°çš„.onnxåç¼€æ¨¡å‹æ–‡ä»¶è¿›è¡Œç²¾åº¦æ ‡å®šå·¥ä½œã€‚

### å¯¹å¯¼å‡ºçš„æ¨¡å‹è¿›è¡Œæµ‹è¯•

è¿è¡Œä»£ç åº“ï¼ˆbpu_yolov8ï¼‰ä¸­onnxruntime-infer.pyæ–‡ä»¶ï¼Œå¯¹å¾—åˆ°çš„.onnxæ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå› ä¸ºåœ¨æ¿è½½ä¸Šï¼Œ.binæ¨¡å‹çš„é¢„æµ‹å¤„ç†æ–¹å¼å’Œ.onnxæ¨¡å‹çš„é¢„æµ‹å¤„ç†æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼Œä¸¤è€…ä¹‹é—´åœ¨ä»£ç å±‚é¢åªå­˜åœ¨è¯»å–æ¨¡å‹æ–¹é¢çš„å·®å¼‚ï¼Œæ‰€ä»¥å¦‚æœonnxæ–‡ä»¶çš„æ£€æŸ¥æ²¡æœ‰é—®é¢˜ï¼Œåœ¨æ¿è½½è¿è¡Œä¸Šä¸€èˆ¬ä¹Ÿé—®é¢˜ä¸å¤§ã€‚

æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯¥æ­¥ä¼šå¯¹è®­ç»ƒé›†çš„ä¸€äº›å›¾ç‰‡è¿›è¡Œè¯•é¢„æµ‹ï¼Œå¦‚æœå¯ä»¥æ­£å¸¸åœ¨ç”»é¢ä¸Šè¾“å‡ºé¢„æµ‹åçš„å›¾åƒï¼Œåˆ™è¯æ˜.onnxæ¨¡å‹çš„è½¬æ¢æ²¡æœ‰é—®é¢˜ã€‚åˆ™å¯ä»¥å¯¹å…¶è¿›è¡Œ.binåç¼€æ¨¡å‹çš„å¯¼å‡ºã€‚

```bash
bash step3_convert_bin.sh
```

### æ¿è½½è¿è¡Œæµ‹è¯•

å°†è½¬æ¢å¥½çš„binæ¨¡å‹å’Œä»£ç åº“é€šè¿‡äº‘ç«¯æ‹·è´åˆ°X3è¿è¡Œæ¿ä¸Šï¼Œè¿›è¡Œè¿è¡Œæµ‹è¯•

```bash
# sudoè§£é”æ¿è½½bpuè¿è¡Œæƒé™ï¼Œä¸åŠ æƒé™çš„è¯æ˜¯åœ¨cpuè¿›è¡Œè¿è¡Œã€‚
sudo python3 step4_interence.py
```

## è¿è¡Œæ•ˆæœ

ä¸‹é¢ä¸‰å¼ å›¾ç‰‡æ˜¯åœ¨æ—­æ—¥x3æ´¾ä¸Šè¿è¡Œåœ¨yoloV8ä¸­è®­ç»ƒçš„æ¨¡å‹å¾—åˆ°çš„ç»“æœï¼Œå¯ä»¥çœ‹åˆ°å·¦ä¾§çš„è¯†åˆ«ç»“æœbounding boxçš„å¤§å°æ­£åˆé€‚ï¼ŒåŒæ—¶åœ¨å³è¾¹çš„ç»ˆç«¯æ§åˆ¶å°å¯ä»¥å¾—å‡ºæ¯å¼ å›¾ç‰‡çš„é¢„æµ‹è¿è¡Œæ—¶é—´å¤§æ¦‚åœ¨220ms-264msä¸ç­‰ï¼ŒåŸºæœ¬ä¸åœ¨ä¸»æœºç«¯è¿è¡Œå¤§æ­£ç³»ç»Ÿçš„æ—¶é—´ç›¸å½“ã€‚å½“ç„¶è¿™å¯èƒ½ä¸æ•°æ®é›†çš„é€‰å–æœ‰å…³ï¼Œå› ä¸ºè¯¥æ•°æ®é›†æ˜¯yoloV8ç»™çš„ç¤ºä¾‹æ•°æ®é›†ã€‚

![æˆªå±2023-03-11 ä¸Šåˆ11.51.25.png](/pictures/pic1.png)

![æˆªå±2023-03-11 ä¸Šåˆ11.47.18.png](/pictures/pic2.png)

![æˆªå±2023-03-11 ä¸Šåˆ11.47.34.png](/pictures/pic3.png)

## æœªæ¥è®¡åˆ’

å®ç°æ‘„åƒå¤´cameraå®æ—¶æ£€æµ‹ã€‚å¹¶åœ¨ä¿è¯ç²¾åº¦çš„æƒ…å†µä¸‹æé«˜è¿è¡Œå¸§æ•°ã€‚